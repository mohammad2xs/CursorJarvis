// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                String   @id @default(cuid())
  name              String
  website           String?
  subIndustry      String   // Aerospace & Defense, Oil & Gas/Energy, Healthcare/MedSys, Consumer/CPG, Tech/SaaS
  region            String
  tags              String[] // priority_initiatives: ESG, Safety, Workforce/DEI, Innovation/Speed, Cost-out
  priorityLevel     PriorityLevel @default(GROWTH)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  contacts          Contact[]
  opportunities     Opportunity[]
  accountSignals    AccountSignal[]
  activities        Activity[]
  tasks             Task[]
  meetings          Meeting[]
  notes             Note[]
  nbas              NBA[]
  revenueAttribution RevenueAttribution[]
  
  @@map("companies")
}

model Contact {
  id                String   @id @default(cuid())
  firstName         String
  lastName          String
  email             String?
  phone             String?
  title             String?
  role              String?  // VP, CMO, etc.
  linkedinUrl       String?
  companyId         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  activities        Activity[]
  meetings          Meeting[]
  tasks             Task[]
  notes             Note[]
  nbas              NBA[]
  revenueAttribution RevenueAttribution[]
  
  @@map("contacts")
}

model Opportunity {
  id                String   @id @default(cuid())
  name              String
  dealType          DealType
  stage             OpportunityStage @default(DISCOVER)
  value             Float?
  probability       Int?     // 0-100
  closeDate         DateTime?
  companyId         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  activities        Activity[]
  meetings          Meeting[]
  tasks             Task[]
  notes             Note[]
  nbas              NBA[]
  revenueAttribution RevenueAttribution[]
  
  @@map("opportunities")
}

model Activity {
  id                String   @id @default(cuid())
  type              ActivityType
  title             String
  description       String?
  outcome           String?
  companyId         String
  contactId         String?
  opportunityId     String?
  createdAt         DateTime @default(now())
  
  // Relations
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact           Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  opportunity       Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  
  @@map("activities")
}

model Task {
  id                String   @id @default(cuid())
  title             String
  description       String?
  type              TaskType
  status            TaskStatus @default(PENDING)
  dueDate           DateTime?
  completedAt       DateTime?
  companyId         String
  contactId         String?
  opportunityId     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact           Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  opportunity       Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  
  @@map("tasks")
}

model Meeting {
  id                String   @id @default(cuid())
  title             String
  description       String?
  type              MeetingType
  status            MeetingStatus @default(SCHEDULED)
  scheduledAt       DateTime
  duration          Int?     // minutes
  meetingUrl        String?
  notes             String?
  outcome           String?
  companyId         String
  contactId         String?
  opportunityId     String?
  calendlyEventId   String?  // For Calendly integration
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact           Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  opportunity       Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  meetingNotes      Note[] @relation("MeetingNotes")
  
  @@map("meetings")
}

model Note {
  id                String   @id @default(cuid())
  content           String
  type              NoteType @default(GENERAL)
  companyId         String
  contactId         String?
  opportunityId     String?
  meetingId         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact           Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  opportunity       Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  meeting           Meeting? @relation("MeetingNotes", fields: [meetingId], references: [id], onDelete: SetNull)
  
  @@map("notes")
}

model AccountSignal {
  id                String   @id @default(cuid())
  title             String
  summary           String
  source            String   // perplexity, sales_navigator, phantom_buster, manual
  url               String?
  detectedAt        DateTime
  tags              String[]
  provenance        String?  // Raw data for audit
  companyId         String
  createdAt         DateTime @default(now())
  
  // Relations
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@map("account_signals")
}

model NBA {
  id                String   @id @default(cuid())
  playType          PlayType
  title             String
  description       String
  rationale         String   // Why this NBA was suggested
  source            String   // Rule match, source links
  status            NBAStatus @default(PENDING)
  priority          Int      // 1-5, higher is more important
  companyId         String
  contactId         String?
  opportunityId     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact           Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  opportunity       Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  
  @@map("nbas")
}

model PerplexityCache {
  id                String   @id @default(cuid())
  query             String
  response          String
  companyId         String?
  ttl               DateTime
  createdAt         DateTime @default(now())
  
  @@map("perplexity_cache")
}

model GoldenPlay {
  id                String   @id @default(cuid())
  playType          PlayType
  segment           String   // sub_industry or role
  acceptanceRate    Float
  replyRate         Float
  meetingRate       Float
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([playType, segment])
  @@map("golden_plays")
}

model RevenueAttribution {
  id                String   @id @default(cuid())
  accountId         String
  contactId         String?
  opportunityId     String?
  revenue           Float
  attributionSource String   // 'direct_sale', 'incidental_purchase', 'renewal', 'expansion'
  attributionReason String?
  conversationId    String?
  callId            String?
  gettyImagesProduct String
  department        String
  useCase           String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  account           Company  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contact           Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  opportunity       Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  
  @@map("revenue_attribution")
}

// Enums
enum PriorityLevel {
  STRATEGIC
  GROWTH
  NURTURE
}

enum DealType {
  NEW_LOGO
  RENEWAL
  UPSELL
  STRATEGIC
}

enum OpportunityStage {
  DISCOVER
  EVALUATE
  PROPOSE
  NEGOTIATE
  CLOSE_WON
  CLOSE_LOST
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  DEMO
  PROPOSAL
  FOLLOW_UP
  RESEARCH
  OUTREACH
}

enum TaskType {
  CALL
  EMAIL
  MEETING_PREP
  FOLLOW_UP
  RESEARCH
  PROPOSAL
  NEGOTIATION
  CLOSE
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MeetingType {
  DISCOVERY
  DEMO
  PROPOSAL
  NEGOTIATION
  FOLLOW_UP
  INTERNAL
}

enum MeetingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum NoteType {
  GENERAL
  MEETING_NOTES
  CALL_NOTES
  RESEARCH
  STRATEGY
}

enum PlayType {
  PRE_MEETING
  POST_MEETING
  NEW_LEAD
  VP_CMO_NO_TOUCH
  OPP_IDLE
  ENGAGEMENT_DETECTED
  PERPLEXITY_NEWS
  PERPLEXITY_HIRE
}

enum NBAStatus {
  PENDING
  APPROVED
  SNOOZED
  DECLINED
  COMPLETED
}

// New CRM Models for AI-First CRM
model Account {
  id                String   @id @default(cuid())
  name              String
  domain            String?
  techStack         String[] // Array of technologies used
  employeesBand     String?  // e.g., "1-10", "11-50", "51-200", etc.
  hqCountry         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  contacts          CrmContact[]
  deals             Deal[]
  activities        CrmActivity[]
  transcripts       Transcript[]
  enrichmentSignals EnrichmentSignal[]
  sequenceEnrollments SequenceEnrollment[]
  agentAuditLogs    AgentAuditLog[]
  
  @@map("accounts")
}

model CrmContact {
  id                String   @id @default(cuid())
  accountId         String
  firstName         String
  lastName          String
  title             String?
  email             String?
  phone             String?
  ownerId           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  account           Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  deals             Deal[]
  activities        CrmActivity[]
  transcripts       Transcript[]
  enrichmentSignals EnrichmentSignal[]
  sequenceEnrollments SequenceEnrollment[]
  agentAuditLogs    AgentAuditLog[]
  
  @@map("crm_contacts")
}

model Lead {
  id                String   @id @default(cuid())
  firstName         String
  lastName          String
  company           String?
  email             String?
  phone             String?
  status            LeadStatus @default(NEW)
  ownerId           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  activities        CrmActivity[]
  transcripts       Transcript[]
  enrichmentSignals EnrichmentSignal[]
  sequenceEnrollments SequenceEnrollment[]
  agentAuditLogs    AgentAuditLog[]
  
  @@map("leads")
}

model Deal {
  id                String   @id @default(cuid())
  accountId         String?
  contactId         String?
  name              String
  stage             DealStage @default(DISCOVERY)
  amount            Float?
  closeDate         DateTime?
  nextStep          String?
  riskScore         Float?   // 0.0 to 1.0, higher is riskier
  ownerId           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  account           Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  contact           CrmContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  activities        CrmActivity[]
  transcripts       Transcript[]
  enrichmentSignals EnrichmentSignal[]
  agentAuditLogs    AgentAuditLog[]
  
  @@map("deals")
}

model CrmActivity {
  id                String   @id @default(cuid())
  recordType        RecordType
  recordId          String
  type              CrmActivityType
  subject           String
  body              String?
  dueDate           DateTime?
  createdBy         String?
  createdAt         DateTime @default(now())
  
  // Relations - polymorphic based on recordType/recordId
  account           Account? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  contact           CrmContact? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  lead              Lead? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  deal              Deal? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  @@map("crm_activities")
}

model Transcript {
  id                String   @id @default(cuid())
  recordType        RecordType
  recordId          String
  source            String   // e.g., "zoom", "gong", "manual"
  text              String   @db.Text
  createdAt         DateTime @default(now())
  
  // Relations - polymorphic based on recordType/recordId
  account           Account? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  contact           CrmContact? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  lead              Lead? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  deal              Deal? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  @@map("transcripts")
}

model EnrichmentSignal {
  id                String   @id @default(cuid())
  recordType        RecordType
  recordId          String
  key               String   // e.g., "technographics", "employee_count", "recent_funding"
  value             String   @db.Text
  confidence        Float    // 0.0 to 1.0
  createdAt         DateTime @default(now())
  
  // Relations - polymorphic based on recordType/recordId
  account           Account? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  contact           CrmContact? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  lead              Lead? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  deal              Deal? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  @@map("enrichment_signals")
}

model Sequence {
  id                String   @id @default(cuid())
  name              String
  profile           String   // Target profile description
  createdBy         String?
  createdAt         DateTime @default(now())
  
  // Relations
  steps             SequenceStep[]
  enrollments       SequenceEnrollment[]
  
  @@map("sequences")
}

model SequenceStep {
  id                String   @id @default(cuid())
  sequenceId        String
  dayOffset         Int      // Days from sequence start
  channel           SequenceChannel
  templateKey       String   // Reference to template/script
  scriptKey         String?  // Optional script reference
  
  // Relations
  sequence          Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  
  @@map("sequence_steps")
}

model SequenceEnrollment {
  id                String   @id @default(cuid())
  sequenceId        String
  recordType        RecordType
  recordId          String
  status            EnrollmentStatus @default(ACTIVE)
  startedAt         DateTime @default(now())
  completedAt       DateTime?
  
  // Relations
  sequence          Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  account           Account? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  contact           CrmContact? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  lead              Lead? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  @@map("sequence_enrollments")
}

model AgentAuditLog {
  id                String   @id @default(cuid())
  agentId           String   // Agent identifier
  capability        String   // Capability name (e.g., "enrichment.waterfall")
  recordType        RecordType?
  recordId          String?
  userId            String?
  orgId             String?
  payloadJson       String   @db.Text  // Input parameters
  resultJson        String   @db.Text  // Agent output
  createdAt         DateTime @default(now())
  
  // Relations - polymorphic based on recordType/recordId
  account           Account? @relation(fields: [recordId], references: [id], onDelete: SetNull)
  contact           CrmContact? @relation(fields: [recordId], references: [id], onDelete: SetNull)
  lead              Lead? @relation(fields: [recordId], references: [id], onDelete: SetNull)
  deal              Deal? @relation(fields: [recordId], references: [id], onDelete: SetNull)
  
  @@map("agent_audit_logs")
}

// New Enums for CRM
enum RecordType {
  ACCOUNT
  CONTACT
  LEAD
  DEAL
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  DISQUALIFIED
}

enum DealStage {
  DISCOVERY
  QUALIFICATION
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum CrmActivityType {
  CALL
  EMAIL
  MEETING
  TASK
  NOTE
  FOLLOW_UP
  RESEARCH
}

enum SequenceChannel {
  EMAIL
  PHONE
  LINKEDIN
  TWITTER
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}